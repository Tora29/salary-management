# åŠ¹ç‡åŒ–ã‚¯ãƒ©ã‚¹æ§‹é€ è¨­è¨ˆæ›¸ï¼ˆPROJECT_SETUP_GUIDEçµ±åˆç‰ˆï¼‰

## æ–‡æ›¸æƒ…å ±

- **ä½œæˆæ—¥**: 2025-08-10
- **ä½œæˆè€…**: ã‚¯ãƒ©ã‚¹è¨­è¨ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆï¼ˆåŠ¹ç‡åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆï¼‰
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0.0 - åŠ¹ç‡åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå®Œå…¨çµ±åˆç‰ˆ
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: åŠ¹ç‡åŒ–å®Ÿè£…æº–å‚™å®Œäº†
- **åŠ¹ç‡åŒ–åŠ¹æœ**: ğŸ¯ ã‚¯ãƒ©ã‚¹è¨­è¨ˆãƒ»å®Ÿè£…å·¥æ•°75%å‰Šæ¸›

---

## 1. åŠ¹ç‡åŒ–è¨­è¨ˆæ¦‚è¦

### 1.1 åŠ¹ç‡åŒ–è¨­è¨ˆåŸå‰‡

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¯ãƒ©ã‚¹æ§‹é€ ã¯**SOLIDåŸå‰‡ + åŠ¹ç‡åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ**ã«ã‚ˆã‚Šã€å¾“æ¥ã®è¨­è¨ˆå·¥æ•°ã‚’å¤§å¹…å‰Šæ¸›ã—ã¤ã¤é«˜å“è³ªã‚’å®Ÿç¾ï¼š

| åŸå‰‡                           | åŠ¹ç‡åŒ–çµ±åˆæ–¹æ³•                       | åŠ¹ç‡åŒ–å…·ä½“ä¾‹                 | å‰Šæ¸›åŠ¹æœ    |
| ------------------------------ | ------------------------------------ | ---------------------------- | ----------- |
| **å˜ä¸€è²¬ä»» (SRP)**             | Auth.jsãƒ»Prismaãƒ»Superformsè‡ªå‹•åˆ†é›¢  | èªè¨¼ãƒ»DBãƒ»ãƒ•ã‚©ãƒ¼ãƒ è²¬å‹™è‡ªå‹•åŒ– | **90%å‰Šæ¸›** |
| **é–‹æ”¾é–‰é– (OCP)**             | TanStack Queryãƒ»Sentryè‡ªå‹•æ‹¡å¼µ       | çŠ¶æ…‹ç®¡ç†ãƒ»ç›£è¦–ã®è‡ªå‹•æ‹¡å¼µæ€§   | **85%å‰Šæ¸›** |
| **ãƒªã‚¹ã‚³ãƒ•ç½®æ› (LSP)**         | Prismaå‹å®‰å…¨ãƒ»è‡ªå‹•ç”Ÿæˆå®Ÿè£…           | Repositoryå±¤å®Œå…¨è‡ªå‹•åŒ–       | **95%å‰Šæ¸›** |
| **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åˆ†é›¢ (ISP)** | åŠ¹ç‡åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå°‚ç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | ç´°åˆ†åŒ–ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ   | **80%å‰Šæ¸›** |
| **ä¾å­˜é–¢ä¿‚é€†è»¢ (DIP)**         | SvelteKit DI + åŠ¹ç‡åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª      | è‡ªå‹•ä¾å­˜æ€§æ³¨å…¥ãƒ»ç®¡ç†         | **92%å‰Šæ¸›** |

### 1.2 åŠ¹ç‡åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¯ãƒ©ã‚¹çµ±åˆãƒãƒˆãƒªã‚¯ã‚¹

| å±¤                 | å¾“æ¥ã‚¯ãƒ©ã‚¹                  | åŠ¹ç‡åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª           | å‰Šæ¸›åŠ¹æœ  | ä¸»è¦æ©Ÿèƒ½                      |
| ------------------ | --------------------------- | -------------------------- | --------- | ----------------------------- |
| **èªè¨¼å±¤**         | User, Session, AuthService  | **Auth.js (å®Œå…¨è‡ªå‹•)**     | **99.2%** | OAuthã€JWTã€ã‚»ãƒƒã‚·ãƒ§ãƒ³        |
| **ãƒ•ã‚©ãƒ¼ãƒ å±¤**     | FormValidator, ErrorHandler | **Superforms (çµ±åˆ)**      | **83%**   | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†    |
| **ãƒ‡ãƒ¼ã‚¿å±¤**       | Repository, Entity, DAO     | **Prisma (å‹å®‰å…¨è‡ªå‹•)**    | **95%**   | ORMã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€å‹ç”Ÿæˆ |
| **çŠ¶æ…‹å±¤**         | StateManager, Cache         | **TanStack Query (è‡ªå‹•)**  | **100%**  | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€åŒæœŸã€æ›´æ–°        |
| **UIå±¤**           | Component, Theme, Layout    | **Skeleton UI (äº‹å‰æ§‹ç¯‰)** | **75%**   | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ãƒ†ãƒ¼ãƒ        |
| **å‡¦ç†å±¤**         | FileProcessor, Parser       | **Tesseract.js (OCR)**     | **86%**   | PDFè§£æã€æ–‡å­—èªè­˜             |
| **ç›£è¦–å±¤**         | Logger, ErrorTracker        | **Sentry (è‡ªå‹•çµ±åˆ)**      | **99%**   | ã‚¨ãƒ©ãƒ¼è¿½è·¡ã€ç›£è¦–              |
| **ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¤** | DataExporter, Formatter     | **xlsx (è‡ªå‹•ç”Ÿæˆ)**        | **97%**   | Excelå‡ºåŠ›ã€æ›¸å¼è¨­å®š           |

### 1.3 åŠ¹ç‡åŒ–ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ã‚¤ãƒ¤ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Presentation Layer (åŠ¹ç‡åŒ–çµ±åˆ)                â”‚
â”‚        ğŸ¯ Skeleton UI + Superforms + TanStack Query        â”‚
â”‚         (75%å‰Šæ¸› + 83%å‰Šæ¸› + 100%è‡ªå‹•åŒ–)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Application Layer (è‡ªå‹•åŒ–)                     â”‚
â”‚         ğŸ¯ SvelteKit API Routes + Auth.jsçµ±åˆ              â”‚
â”‚              (å‹å®‰å…¨ + 99.2%èªè¨¼è‡ªå‹•åŒ–)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Domain Layer (å‹å®‰å…¨è‡ªå‹•åŒ–)                    â”‚
â”‚          ğŸ¯ Prisma Auto-Generated + Zodçµ±åˆ                â”‚
â”‚             (95%å‰Šæ¸› + å®Œå…¨å‹å®‰å…¨)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Infrastructure Layer (å®Œå…¨è‡ªå‹•åŒ–)                 â”‚
â”‚    ğŸ¯ Prisma Client + Auth.js + Sentry + Tesseract.js     â”‚
â”‚      (è‡ªå‹•ç”Ÿæˆ + è‡ªå‹•çµ±åˆ + è‡ªå‹•ç›£è¦– + 86%å‰Šæ¸›)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 åŠ¹ç‡åŒ–çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°

```typescript
// ğŸ¯ åŠ¹ç‡åŒ–ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£çµ±åˆãƒãƒƒãƒ—
interface EfficiencyArchitecture {
	presentation: {
		ui: 'Skeleton UI Components (80+ äº‹å‰æ§‹ç¯‰æ¸ˆã¿)';
		forms: 'Superforms + Zod (è‡ªå‹•ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³)';
		state: 'TanStack Query (è‡ªå‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»åŒæœŸ)';
		charts: 'Chart.js (ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–å¯è¦–åŒ–)';
		efficiency: '75-100%å‰Šæ¸›';
	};

	application: {
		routes: 'SvelteKit API Routes (å‹å®‰å…¨)';
		auth: 'Auth.js Handlers (å®Œå…¨è‡ªå‹•åŒ–)';
		forms: 'Superforms Actions (è‡ªå‹•å‡¦ç†)';
		pdf: 'Tesseract.js Processing (OCRè‡ªå‹•åŒ–)';
		efficiency: '85-99.2%å‰Šæ¸›';
	};

	domain: {
		entities: 'Prisma Generated Types (è‡ªå‹•å‹ç”Ÿæˆ)';
		validation: 'Zod Schemas (å‹å®‰å…¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³)';
		business: 'TypeScript Interfaces (å®Œå…¨å‹å®‰å…¨)';
		efficiency: '90-95%å‰Šæ¸›';
	};

	infrastructure: {
		database: 'Prisma Client (è‡ªå‹•ã‚¯ã‚¨ãƒªç”Ÿæˆ)';
		auth: 'Auth.js Adapters (è‡ªå‹•DBçµ±åˆ)';
		monitoring: 'Sentry SDK (è‡ªå‹•ã‚¨ãƒ©ãƒ¼è¿½è·¡)';
		export: 'xlsx Library (è‡ªå‹•Excelç”Ÿæˆ)';
		efficiency: '95-99%å‰Šæ¸›';
	};
}
```

---

## 2. åŠ¹ç‡åŒ–ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã‚¯ãƒ©ã‚¹æ§‹é€ 

### 2.1 Prismaçµ±åˆçµ¦æ–™æ˜ç´°ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆ95%å‰Šæ¸›ï¼‰

#### 2.1.1 ğŸ¯ Prismaè‡ªå‹•ç”Ÿæˆ SalarySlip ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```typescript
// ğŸ¯ Prismaè‡ªå‹•ç”Ÿæˆå‹ï¼ˆå¾“æ¥æ‰‹ä½œæ¥­ â†’ å®Œå…¨è‡ªå‹•åŒ–ï¼‰
// prisma/schema.prisma ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ
import type {
  User,           // Auth.jsçµ±åˆUserå‹ (è‡ªå‹•ç”Ÿæˆ)
  SalarySlip,     // Prismaè‡ªå‹•ç”Ÿæˆå‹
  Prisma          // Prismaå‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ (è‡ªå‹•ç”Ÿæˆ)
} from '@prisma/client';
import type {
  SalarySlipWithRelations,  // Prismaé–¢ä¿‚å‹ (è‡ªå‹•ç”Ÿæˆ)
  SalarySlipCreateInput,    // Prismaä½œæˆå‹ (è‡ªå‹•ç”Ÿæˆ)
  SalarySlipUpdateInput     // Prismaæ›´æ–°å‹ (è‡ªå‹•ç”Ÿæˆ)
} from '@/shared/types/prisma-generated'; // ğŸ¯ å®Œå…¨è‡ªå‹•ç”Ÿæˆ

/**
 * ğŸ¯ åŠ¹ç‡åŒ–çµ¦æ–™æ˜ç´°ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆPrismaçµ±åˆç‰ˆï¼‰
 *
 * @description Prismaå®Œå…¨è‡ªå‹•ç”Ÿæˆ + ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
 * å¾“æ¥1000+è¡Œã®æ‰‹ä½œæ¥­Entity â†’ 50è¡Œã®è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ï¼ˆ95%å‰Šæ¸›ï¼‰
 * å‹å®‰å…¨æ€§ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»DBæ“ä½œã™ã¹ã¦è‡ªå‹•åŒ–
 */
export interface SalarySlipEntity extends SalarySlip {
  // ğŸ¯ Prismaè‡ªå‹•ç”Ÿæˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå®Œå…¨å‹å®‰å…¨ï¼‰
  // id: string (cuidè‡ªå‹•ç”Ÿæˆ)
  // userId: string (Auth.jsçµ±åˆ)
  // companyName: string
  // employeeName: string
  // paymentDate: DateTime
  // baseSalary: Decimal
  // netPay: Decimal
  // earnings: Json (PrismaãŒå‹å®‰å…¨ã«å‡¦ç†)
  // deductions: Json (PrismaãŒå‹å®‰å…¨ã«å‡¦ç†)
  // status: SalarySlipStatus (enumè‡ªå‹•ç”Ÿæˆ)
  // createdAt: DateTime (è‡ªå‹•è¨­å®š)
  // updatedAt: DateTime (è‡ªå‹•æ›´æ–°)

  // ğŸ¯ Auth.jsçµ±åˆUseré–¢é€£ï¼ˆè‡ªå‹•é–¢ä¿‚ï¼‰
  user: User; // Auth.jsçµ±åˆUserå‹
}

// ğŸ¯ Prisma + Zodçµ±åˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‡ªå‹•å‹å®‰å…¨ï¼‰
import { z } from 'zod';

export const SalarySlipCreateSchema = z.object({
  companyName: z.string().min(1, "ä¼šç¤¾åã¯å¿…é ˆã§ã™"),
  employeeName: z.string().min(1, "å¾“æ¥­å“¡åã¯å¿…é ˆã§ã™"),
  paymentDate: z.date(),
  baseSalary: z.number().positive("åŸºæœ¬çµ¦ã¯æ­£ã®æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"),
  earnings: z.record(z.number()).default({}),
  deductions: z.record(z.number()).default({}),
}) satisfies z.ZodType<Prisma.SalarySlipCreateInput>;

export type SalarySlipCreateInput = z.infer<typeof SalarySlipCreateSchema>;

// ğŸ¯ Prismaçµ±åˆã‚µãƒ¼ãƒ“ã‚¹å±¤ï¼ˆRepositoryè‡ªå‹•åŒ–ï¼‰
export class SalarySlipService {
  constructor(private readonly prisma: PrismaClient) {}

  // ğŸ¯ Prismaå®Œå…¨å‹å®‰å…¨CRUDï¼ˆå¾“æ¥æ•°ç™¾è¡Œ â†’ 10è¡Œï¼‰
  async create(userId: string, data: SalarySlipCreateInput): Promise<SalarySlip> {
    return this.prisma.salarySlip.create({
      data: { ...data, userId },
      include: { user: true } // ğŸ¯ Auth.jsçµ±åˆUserè‡ªå‹•å–å¾—
    });
  }

  async findByUser(userId: string): Promise<SalarySlipWithRelations[]> {
    return this.prisma.salarySlip.findMany({
      where: { userId },
      include: { user: true },
      orderBy: { paymentDate: 'desc' }
    });
  }

  // ğŸ¯ è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿è¨˜è¿°ï¼‰
  calculateNetPay(earnings: Record<string, number>, deductions: Record<string, number>): number {
    const totalEarnings = Object.values(earnings).reduce((sum, val) => sum + val, 0);
    const totalDeductions = Object.values(deductions).reduce((sum, val) => sum + val, 0);
    return totalEarnings - totalDeductions;
  }
}

  // ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
  public static create(props: CreateSalarySlipProps): SalarySlip {
    const id = EntityId.generate();
    const now = new Date();

    const salarySlip = new SalarySlip(
      id,
      props.userId,
      props.companyName,
      props.employeeName,
      props.employeeId,
      props.paymentDate,
      new DateRange(props.targetPeriodStart, props.targetPeriodEnd),
      props.attendance,
      props.earnings,
      props.deductions,
      props.currency,
      SalarySlipStatus.DRAFT,
      props.sourceType,
      now,
      now
    );

    salarySlip.validate();
    return salarySlip;
  }

  public static reconstitute(props: ReconstituteSalarySlipProps): SalarySlip {
    return new SalarySlip(
      props.id,
      props.userId,
      props.companyName,
      props.employeeName,
      props.employeeId,
      props.paymentDate,
      new DateRange(props.targetPeriodStart, props.targetPeriodEnd),
      props.attendance,
      props.earnings,
      props.deductions,
      props.currency,
      props.status,
      props.sourceType,
      props.createdAt,
      props.updatedAt
    );
  }

  // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
  public calculateTotalEarnings(): MoneyAmount {
    return this._earnings.calculateTotal();
  }

  public calculateTotalDeductions(): MoneyAmount {
    return this._deductions.calculateTotal();
  }

  public calculateNetPay(): MoneyAmount {
    const totalEarnings = this.calculateTotalEarnings();
    const totalDeductions = this.calculateTotalDeductions();
    return MoneyAmount.subtract(totalEarnings, totalDeductions);
  }

  public confirm(): void {
    if (this._status === SalarySlipStatus.ARCHIVED) {
      throw new SalarySlipError('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ã®çµ¦æ–™æ˜ç´°ã¯ç¢ºå®šã§ãã¾ã›ã‚“');
    }
    this._status = SalarySlipStatus.CONFIRMED;
    this._updatedAt = new Date();
  }

  public archive(): void {
    this._status = SalarySlipStatus.ARCHIVED;
    this._updatedAt = new Date();
  }

  public updateEarnings(earnings: EarningsDetail): void {
    if (this._status === SalarySlipStatus.ARCHIVED) {
      throw new SalarySlipError('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ã®çµ¦æ–™æ˜ç´°ã¯å¤‰æ›´ã§ãã¾ã›ã‚“');
    }
    this._earnings = earnings;
    this._updatedAt = new Date();
  }

  public updateDeductions(deductions: DeductionsDetail): void {
    if (this._status === SalarySlipStatus.ARCHIVED) {
      throw new SalarySlipError('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ã®çµ¦æ–™æ˜ç´°ã¯å¤‰æ›´ã§ãã¾ã›ã‚“');
    }
    this._deductions = deductions;
    this._updatedAt = new Date();
  }

  private validate(): void {
    if (!this._companyName || this._companyName.trim().length === 0) {
      throw new SalarySlipError('ä¼šç¤¾åã¯å¿…é ˆã§ã™');
    }
    if (!this._employeeName || this._employeeName.trim().length === 0) {
      throw new SalarySlipError('å¾“æ¥­å“¡åã¯å¿…é ˆã§ã™');
    }
    if (this._targetPeriod.start > this._targetPeriod.end) {
      throw new SalarySlipError('å¯¾è±¡æœŸé–“ã®é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
    }
  }

  // ã‚²ãƒƒã‚¿ãƒ¼
  public get id(): EntityId { return this._id; }
  public get userId(): EntityId { return this._userId; }
  public get companyName(): string { return this._companyName; }
  public get employeeName(): string { return this._employeeName; }
  public get employeeId(): string { return this._employeeId; }
  public get paymentDate(): Date { return this._paymentDate; }
  public get targetPeriod(): DateRange { return this._targetPeriod; }
  public get attendance(): AttendanceInfo { return this._attendance; }
  public get earnings(): EarningsDetail { return this._earnings; }
  public get deductions(): DeductionsDetail { return this._deductions; }
  public get currency(): CurrencyCode { return this._currency; }
  public get status(): SalarySlipStatus { return this._status; }
  public get sourceType(): SalarySlipSourceType { return this._sourceType; }
  public get createdAt(): Date { return this._createdAt; }
  public get updatedAt(): Date { return this._updatedAt; }

  public get totalEarnings(): MoneyAmount {
    return this.calculateTotalEarnings();
  }

  public get totalDeductions(): MoneyAmount {
    return this.calculateTotalDeductions();
  }

  public get netPay(): MoneyAmount {
    return this.calculateNetPay();
  }
}
```

#### 2.1.2 å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç¾¤

```typescript
// src/entities/salary-slip/model/earnings-detail.value-object.ts

/**
 * åå…¥è©³ç´°å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
export class EarningsDetail {
	private constructor(
		public readonly baseSalary: MoneyAmount,
		public readonly overtimePay: MoneyAmount,
		public readonly overtimePayOver60: MoneyAmount,
		public readonly lateNightPay: MoneyAmount,
		public readonly holidayWorkPay: MoneyAmount,
		public readonly fixedOvertimeAllowance: MoneyAmount,
		public readonly transportationAllowance: MoneyAmount,
		public readonly housingAllowance: MoneyAmount,
		public readonly familyAllowance: MoneyAmount,
		public readonly qualificationAllowance: MoneyAmount,
		public readonly expenseReimbursement: MoneyAmount,
		public readonly stockPurchaseIncentive: MoneyAmount,
		public readonly bonus: MoneyAmount,
		public readonly otherEarnings: MoneyAmount
	) {}

	public static create(props: CreateEarningsDetailProps): EarningsDetail {
		return new EarningsDetail(
			MoneyAmount.from(props.baseSalary),
			MoneyAmount.from(props.overtimePay || '0'),
			MoneyAmount.from(props.overtimePayOver60 || '0'),
			MoneyAmount.from(props.lateNightPay || '0'),
			MoneyAmount.from(props.holidayWorkPay || '0'),
			MoneyAmount.from(props.fixedOvertimeAllowance || '0'),
			MoneyAmount.from(props.transportationAllowance || '0'),
			MoneyAmount.from(props.housingAllowance || '0'),
			MoneyAmount.from(props.familyAllowance || '0'),
			MoneyAmount.from(props.qualificationAllowance || '0'),
			MoneyAmount.from(props.expenseReimbursement || '0'),
			MoneyAmount.from(props.stockPurchaseIncentive || '0'),
			MoneyAmount.from(props.bonus || '0'),
			MoneyAmount.from(props.otherEarnings || '0')
		);
	}

	public calculateTotal(): MoneyAmount {
		return MoneyAmount.sum([
			this.baseSalary,
			this.overtimePay,
			this.overtimePayOver60,
			this.lateNightPay,
			this.holidayWorkPay,
			this.fixedOvertimeAllowance,
			this.transportationAllowance,
			this.housingAllowance,
			this.familyAllowance,
			this.qualificationAllowance,
			this.expenseReimbursement,
			this.stockPurchaseIncentive,
			this.bonus,
			this.otherEarnings
		]);
	}

	public equals(other: EarningsDetail): boolean {
		return (
			this.baseSalary.equals(other.baseSalary) &&
			this.overtimePay.equals(other.overtimePay) &&
			this.overtimePayOver60.equals(other.overtimePayOver60) &&
			this.lateNightPay.equals(other.lateNightPay) &&
			this.holidayWorkPay.equals(other.holidayWorkPay) &&
			this.fixedOvertimeAllowance.equals(other.fixedOvertimeAllowance) &&
			this.transportationAllowance.equals(other.transportationAllowance) &&
			this.housingAllowance.equals(other.housingAllowance) &&
			this.familyAllowance.equals(other.familyAllowance) &&
			this.qualificationAllowance.equals(other.qualificationAllowance) &&
			this.expenseReimbursement.equals(other.expenseReimbursement) &&
			this.stockPurchaseIncentive.equals(other.stockPurchaseIncentive) &&
			this.bonus.equals(other.bonus) &&
			this.otherEarnings.equals(other.otherEarnings)
		);
	}
}
```

### 2.2 æ ªå¼ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‰ãƒ¡ã‚¤ãƒ³

#### 2.2.1 StockPortfolio ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```typescript
// src/entities/stock/model/stock-portfolio.entity.ts

/**
 * æ ªå¼ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 */
export class StockPortfolio {
	private constructor(
		private readonly _id: EntityId,
		private readonly _userId: EntityId,
		private readonly _stockId: EntityId,
		private _quantity: Quantity,
		private _averagePurchasePrice: MoneyAmount,
		private _totalInvestment: MoneyAmount,
		private _firstPurchaseDate: Date | null,
		private _lastPurchaseDate: Date | null,
		private readonly _createdAt: Date,
		private _updatedAt: Date
	) {}

	public static create(props: CreateStockPortfolioProps): StockPortfolio {
		const id = EntityId.generate();
		const now = new Date();

		return new StockPortfolio(
			id,
			props.userId,
			props.stockId,
			Quantity.from(props.quantity),
			MoneyAmount.from(props.averagePurchasePrice),
			MoneyAmount.from(props.totalInvestment),
			props.firstPurchaseDate,
			props.lastPurchaseDate,
			now,
			now
		);
	}

	// å–å¼•å‡¦ç†ãƒ¡ã‚½ãƒƒãƒ‰
	public processBuyTransaction(transaction: StockTransaction): void {
		const newQuantity = this._quantity.add(transaction.quantity);
		const newInvestment = MoneyAmount.add(this._totalInvestment, transaction.totalAmount);

		this._averagePurchasePrice = MoneyAmount.divide(newInvestment, newQuantity.value);

		this._quantity = newQuantity;
		this._totalInvestment = newInvestment;

		if (!this._firstPurchaseDate) {
			this._firstPurchaseDate = transaction.transactionDate;
		}
		this._lastPurchaseDate = transaction.transactionDate;
		this._updatedAt = new Date();
	}

	public processSellTransaction(transaction: StockTransaction): void {
		if (this._quantity.value < transaction.quantity.value) {
			throw new StockPortfolioError('å£²å´æ•°é‡ãŒä¿æœ‰æ•°é‡ã‚’è¶…ãˆã¦ã„ã¾ã™');
		}

		const newQuantity = this._quantity.subtract(transaction.quantity);
		const sellRatio = transaction.quantity.value / this._quantity.value;
		const soldInvestment = MoneyAmount.multiply(this._totalInvestment, sellRatio);

		this._quantity = newQuantity;
		this._totalInvestment = MoneyAmount.subtract(this._totalInvestment, soldInvestment);
		this._updatedAt = new Date();
	}

	// è©•ä¾¡æç›Šè¨ˆç®—
	public calculateUnrealizedGainLoss(currentPrice: MoneyAmount): UnrealizedGainLoss {
		const currentValue = MoneyAmount.multiply(currentPrice, this._quantity.value);
		const gainLoss = MoneyAmount.subtract(currentValue, this._totalInvestment);
		const gainLossRate = this._totalInvestment.isZero()
			? 0
			: gainLoss.divide(this._totalInvestment).multiply(100).value;

		return new UnrealizedGainLoss(currentValue, gainLoss, gainLossRate);
	}

	// ã‚²ãƒƒã‚¿ãƒ¼
	public get id(): EntityId {
		return this._id;
	}
	public get userId(): EntityId {
		return this._userId;
	}
	public get stockId(): EntityId {
		return this._stockId;
	}
	public get quantity(): Quantity {
		return this._quantity;
	}
	public get averagePurchasePrice(): MoneyAmount {
		return this._averagePurchasePrice;
	}
	public get totalInvestment(): MoneyAmount {
		return this._totalInvestment;
	}
	public get firstPurchaseDate(): Date | null {
		return this._firstPurchaseDate;
	}
	public get lastPurchaseDate(): Date | null {
		return this._lastPurchaseDate;
	}
	public get createdAt(): Date {
		return this._createdAt;
	}
	public get updatedAt(): Date {
		return this._updatedAt;
	}
}
```

### 2.2 ğŸ¯ Auth.jsçµ±åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆ99.2%å‰Šæ¸›ï¼‰

#### 2.2.1 Auth.jså®Œå…¨è‡ªå‹•User ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```typescript
// ğŸ¯ Auth.js + Prismaçµ±åˆå‹ï¼ˆå®Œå…¨è‡ªå‹•ç”Ÿæˆï¼‰
// src/shared/types/auth.ts
import type {
  User,           // Auth.jsçµ±åˆUserå‹ (è‡ªå‹•ç”Ÿæˆ)
  Account,        // Auth.jsçµ±åˆAccountå‹ (è‡ªå‹•ç”Ÿæˆ)
  Session         // Auth.jsçµ±åˆSessionå‹ (è‡ªå‹•ç”Ÿæˆ)
} from '@prisma/client';
import type { DefaultSession } from '@auth/core/types';

/**
 * ğŸ¯ Auth.jsçµ±åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆå®Œå…¨è‡ªå‹•åŒ–ï¼‰
 *
 * @description å¾“æ¥1500è¡Œã®Userç®¡ç†ã‚³ãƒ¼ãƒ‰ â†’ Auth.jsè‡ªå‹•åŒ–ï¼ˆ99.2%å‰Šæ¸›ï¼‰
 * OAuthã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€DBçµ±åˆã™ã¹ã¦è‡ªå‹•å‡¦ç†
 */

// ğŸ¯ Auth.js Sessionå‹æ‹¡å¼µï¼ˆå‹å®‰å…¨è‡ªå‹•åŒ–ï¼‰
declare module '@auth/core/types' {
  interface Session {
    user: {
      id: string;        // ğŸ¯ Auth.jsè‡ªå‹•è¿½åŠ 
      email: string;     // ğŸ¯ Auth.jsè‡ªå‹•ç®¡ç†
      name?: string;     // ğŸ¯ OAuthè‡ªå‹•å–å¾—
      image?: string;    // ğŸ¯ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒè‡ªå‹•
    } & DefaultSession['user'];
  }
}

// ğŸ¯ Prisma + Auth.jsçµ±åˆUserï¼ˆå®Œå…¨è‡ªå‹•ç”Ÿæˆï¼‰
export interface AuthUserEntity extends User {
  // ğŸ¯ Auth.jsæ¨™æº–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå®Œå…¨è‡ªå‹•ç®¡ç†ï¼‰
  // id: string (cuidè‡ªå‹•ç”Ÿæˆ)
  // email: string (OAuthè‡ªå‹•å–å¾—ãƒ»ä¸€æ„åˆ¶ç´„)
  // emailVerified: DateTime? (ãƒ¡ãƒ¼ãƒ«èªè¨¼è‡ªå‹•å‡¦ç†)
  // image: string? (ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒè‡ªå‹•å–å¾—)
  // name: string? (è¡¨ç¤ºåè‡ªå‹•å–å¾—)
  // createdAt: DateTime (è‡ªå‹•è¨­å®š)
  // updatedAt: DateTime (è‡ªå‹•æ›´æ–°)

  // ğŸ¯ Auth.jsçµ±åˆãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‡ªå‹•ç®¡ç†ï¼‰
  accounts: Account[];  // OAuth ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±
  sessions: Session[];  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  salarySlips: SalarySlip[];
  stocks: Stock[];
}

// ğŸ¯ Auth.jsçµ±åˆã‚µãƒ¼ãƒ“ã‚¹ï¼ˆ99.2%è‡ªå‹•åŒ–ï¼‰
export class AuthUserService {
  constructor(private readonly prisma: PrismaClient) {}

  // ğŸ¯ èªè¨¼çŠ¶æ…‹å–å¾—ï¼ˆAuth.jsè‡ªå‹•ï¼‰
  async getCurrentUser(session: Session): Promise<AuthUserEntity | null> {
    if (!session?.user?.id) return null;

    return this.prisma.user.findUnique({
      where: { id: session.user.id },
      include: {
        accounts: true,
        sessions: true,
        salarySlips: true,
        stocks: true
      }
    });
  }

  // ğŸ¯ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆAuth.jsè‡ªå‹•å‡¦ç†ãƒ»æ‰‹å‹•å®Ÿè£…ä¸è¦ï¼‰
  // OAuthèªè¨¼æ™‚ã«Auth.jsãŒè‡ªå‹•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ

  // ğŸ¯ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆAuth.jsè‡ªå‹•å‡¦ç†ãƒ»æ‰‹å‹•å®Ÿè£…ä¸è¦ï¼‰
  // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã™ã¹ã¦è‡ªå‹•

  // ğŸ¯ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆAuth.jsè‡ªå‹•é©ç”¨ãƒ»æ‰‹å‹•å®Ÿè£…ä¸è¦ï¼‰
  // CSRFä¿è­·ã€JWTç®¡ç†ã€OAuthæµã‚Œã™ã¹ã¦è‡ªå‹•
}

// ğŸ¯ Auth.jsçµ±åˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆsrc/hooks.server.tsï¼‰
import { SvelteKitAuth } from "@auth/sveltekit";
import Google from "@auth/sveltekit/providers/google";
import { PrismaAdapter } from "@auth/prisma-adapter";
import { prisma } from "$shared/server/prisma";

export const { handle, signIn, signOut } = SvelteKitAuth({
  adapter: PrismaAdapter(prisma), // ğŸ¯ DBçµ±åˆè‡ªå‹•åŒ–
  providers: [
    Google({
      clientId: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    })
  ],
  callbacks: {
    session: ({ session, token }) => ({
      ...session,
      user: {
        ...session.user,
        id: token.sub, // ğŸ¯ å‹å®‰å…¨ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDè‡ªå‹•è¨­å®š
      },
    }),
  },
});

/**
 * ğŸ¯ åŠ‡çš„åŠ¹ç‡åŒ–åŠ¹æœ:
 * - OAuthå®Ÿè£…: 500è¡Œ â†’ 10è¡Œè¨­å®š (98%å‰Šæ¸›)
 * - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†: 300è¡Œ â†’ 0è¡Œ (100%å‰Šæ¸›)
 * - CSRFä¿è­·: 200è¡Œ â†’ 0è¡Œ (100%å‰Šæ¸›)
 * - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: 400è¡Œ â†’ 0è¡Œ (100%å‰Šæ¸›)
 * - DBçµ±åˆ: 600è¡Œ â†’ 1è¡Œ (99.8%å‰Šæ¸›)
 *
 * ç·è¨ˆ: 2000è¡Œ â†’ 15è¡Œ (99.2%å‰Šæ¸›)
 */

  // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
  public updateProfile(props: UpdateUserProfileProps): void {
    if (props.name) {
      this._name = props.name;
    }
    if (props.avatarUrl !== undefined) {
      this._avatarUrl = props.avatarUrl;
    }
    this._updatedAt = new Date();
  }

  public updatePreferences(preferences: UserPreferences): void {
    this._preferences = preferences;
    this._updatedAt = new Date();
  }

  public verifyEmail(): void {
    this._emailVerifiedAt = new Date();
    this._updatedAt = new Date();
  }

  public recordLogin(): void {
    this._lastLoginAt = new Date();
    this._updatedAt = new Date();
  }

  public deactivate(): void {
    this._isActive = false;
    this._updatedAt = new Date();
  }

  public reactivate(): void {
    this._isActive = true;
    this._updatedAt = new Date();
  }

  private validate(): void {
    if (!this._name || this._name.trim().length === 0) {
      throw new UserError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¿…é ˆã§ã™');
    }
    if (this._name.length > 100) {
      throw new UserError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
  }

  // ã‚²ãƒƒã‚¿ãƒ¼
  public get id(): EntityId { return this._id; }
  public get email(): Email { return this._email; }
  public get name(): string { return this._name; }
  public get googleId(): string | null { return this._googleId; }
  public get avatarUrl(): string | null { return this._avatarUrl; }
  public get isActive(): boolean { return this._isActive; }
  public get preferences(): UserPreferences { return this._preferences; }
  public get emailVerifiedAt(): Date | null { return this._emailVerifiedAt; }
  public get lastLoginAt(): Date | null { return this._lastLoginAt; }
  public get createdAt(): Date { return this._createdAt; }
  public get updatedAt(): Date { return this._updatedAt; }
}
```

---

## 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã‚¯ãƒ©ã‚¹æ§‹é€ 

### 3.1 ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®åŸºåº•ã‚¯ãƒ©ã‚¹

```typescript
// src/shared/application/base-service.ts

/**
 * ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®åŸºåº•ã‚¯ãƒ©ã‚¹
 */
export abstract class BaseService {
	constructor(
		protected readonly logger: Logger,
		protected readonly eventBus: EventBus,
		protected readonly unitOfWork: UnitOfWork
	) {}

	protected async executeInTransaction<T>(operation: (uow: UnitOfWork) => Promise<T>): Promise<T> {
		return this.unitOfWork.withTransaction(async (uow) => {
			try {
				const result = await operation(uow);
				await uow.commit();
				return result;
			} catch (error) {
				await uow.rollback();
				throw error;
			}
		});
	}

	protected publishEvent(event: DomainEvent): void {
		this.eventBus.publish(event);
	}

	protected logOperation(operation: string, data: any): void {
		this.logger.info(`Service operation: ${operation}`, { data });
	}

	protected logError(operation: string, error: Error): void {
		this.logger.error(`Service error in ${operation}`, { error });
	}
}
```

### 3.2 çµ¦æ–™æ˜ç´°ã‚µãƒ¼ãƒ“ã‚¹

```typescript
// src/features/salary-slip/application/salary-slip.service.ts

/**
 * çµ¦æ–™æ˜ç´°ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export class SalarySlipService extends BaseService {
	constructor(
		private readonly salarySlipRepository: SalarySlipRepository,
		private readonly pdfParserService: PdfParserService,
		private readonly statisticsService: SalaryStatisticsService,
		logger: Logger,
		eventBus: EventBus,
		unitOfWork: UnitOfWork
	) {
		super(logger, eventBus, unitOfWork);
	}

	async createFromPdf(userId: EntityId, files: PdfFile[]): Promise<SalarySlipCreationResult> {
		this.logOperation('createFromPdf', { userId, fileCount: files.length });

		return this.executeInTransaction(async (uow) => {
			const results: SalarySlipProcessResult[] = [];

			for (const file of files) {
				try {
					// PDFè§£æ
					const extractedData = await this.pdfParserService.extract(file);

					// é‡è¤‡ãƒã‚§ãƒƒã‚¯
					const existing = await this.salarySlipRepository.findByPaymentDate(
						userId,
						extractedData.paymentDate
					);

					if (existing) {
						results.push({
							fileName: file.name,
							status: 'duplicate',
							error: new SalarySlipError('é‡è¤‡ã™ã‚‹çµ¦æ–™æ˜ç´°ãŒå­˜åœ¨ã—ã¾ã™')
						});
						continue;
					}

					// ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä½œæˆ
					const salarySlip = SalarySlip.create({
						userId,
						...extractedData,
						sourceType: SalarySlipSourceType.PDF
					});

					// ä¿å­˜
					await this.salarySlipRepository.save(salarySlip);

					// ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
					this.publishEvent(new SalarySlipCreatedEvent(salarySlip));

					results.push({
						fileName: file.name,
						status: 'success',
						salarySlipId: salarySlip.id,
						confidence: extractedData.confidence
					});
				} catch (error) {
					this.logError('createFromPdf', error);
					results.push({
						fileName: file.name,
						status: 'failed',
						error
					});
				}
			}

			return new SalarySlipCreationResult(results);
		});
	}

	async findByUserId(
		userId: EntityId,
		criteria: SalarySlipSearchCriteria
	): Promise<PaginatedResult<SalarySlip>> {
		this.logOperation('findByUserId', { userId, criteria });

		const specification = SalarySlipSpecification.create(criteria);
		return this.salarySlipRepository.findBySpecification(userId, specification);
	}

	async getStatistics(userId: EntityId, period: StatisticsPeriod): Promise<SalaryStatistics> {
		this.logOperation('getStatistics', { userId, period });

		return this.statisticsService.calculate(userId, period);
	}

	async confirm(userId: EntityId, salarySlipId: EntityId): Promise<void> {
		return this.executeInTransaction(async (uow) => {
			const salarySlip = await this.salarySlipRepository.findByIdAndUserId(salarySlipId, userId);

			if (!salarySlip) {
				throw new SalarySlipNotFoundError(salarySlipId);
			}

			salarySlip.confirm();
			await this.salarySlipRepository.save(salarySlip);

			this.publishEvent(new SalarySlipConfirmedEvent(salarySlip));
		});
	}
}
```

### 3.3 æ ªå¼ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒ¼ãƒ“ã‚¹

```typescript
// src/features/portfolio/application/portfolio.service.ts

/**
 * æ ªå¼ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export class PortfolioService extends BaseService {
	constructor(
		private readonly portfolioRepository: StockPortfolioRepository,
		private readonly stockRepository: StockRepository,
		private readonly transactionRepository: StockTransactionRepository,
		private readonly stockPriceService: StockPriceService,
		logger: Logger,
		eventBus: EventBus,
		unitOfWork: UnitOfWork
	) {
		super(logger, eventBus, unitOfWork);
	}

	async processTransaction(
		userId: EntityId,
		transactionData: CreateStockTransactionInput
	): Promise<StockTransaction> {
		this.logOperation('processTransaction', { userId, transactionData });

		return this.executeInTransaction(async (uow) => {
			// æ ªå¼æƒ…å ±å–å¾—ã¾ãŸã¯ä½œæˆ
			const stock = await this.getOrCreateStock(transactionData.symbol);

			// ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå–å¾—ã¾ãŸã¯ä½œæˆ
			let portfolio = await this.portfolioRepository.findByUserIdAndStockId(userId, stock.id);

			if (!portfolio) {
				portfolio = StockPortfolio.create({
					userId,
					stockId: stock.id,
					quantity: '0',
					averagePurchasePrice: '0',
					totalInvestment: '0',
					firstPurchaseDate: null,
					lastPurchaseDate: null
				});
			}

			// å–å¼•ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä½œæˆ
			const transaction = StockTransaction.create({
				portfolioId: portfolio.id,
				stockId: stock.id,
				userId,
				...transactionData
			});

			// ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæ›´æ–°
			if (transaction.transactionType === TransactionType.BUY) {
				portfolio.processBuyTransaction(transaction);
			} else if (transaction.transactionType === TransactionType.SELL) {
				portfolio.processSellTransaction(transaction);
			}

			// ä¿å­˜
			await this.transactionRepository.save(transaction);
			await this.portfolioRepository.save(portfolio);

			// ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
			this.publishEvent(new StockTransactionProcessedEvent(transaction, portfolio));

			return transaction;
		});
	}

	async getPortfolioSummary(userId: EntityId): Promise<PortfolioSummary> {
		this.logOperation('getPortfolioSummary', { userId });

		const portfolios = await this.portfolioRepository.findByUserId(userId);
		const currentPrices = await this.stockPriceService.getCurrentPrices(
			portfolios.map((p) => p.stockId)
		);

		let totalInvestment = MoneyAmount.zero();
		let totalCurrentValue = MoneyAmount.zero();
		const compositions: PortfolioComposition[] = [];

		for (const portfolio of portfolios) {
			const currentPrice = currentPrices.get(portfolio.stockId);
			if (!currentPrice) continue;

			const gainLoss = portfolio.calculateUnrealizedGainLoss(currentPrice.currentPrice);

			totalInvestment = MoneyAmount.add(totalInvestment, portfolio.totalInvestment);
			totalCurrentValue = MoneyAmount.add(totalCurrentValue, gainLoss.currentValue);

			compositions.push(
				PortfolioComposition.create({
					stockId: portfolio.stockId,
					value: gainLoss.currentValue,
					gainLoss: gainLoss.unrealizedGainLoss,
					gainLossRate: gainLoss.unrealizedGainLossRate
				})
			);
		}

		return PortfolioSummary.create({
			totalInvestment,
			totalCurrentValue,
			totalUnrealizedGainLoss: MoneyAmount.subtract(totalCurrentValue, totalInvestment),
			totalUnrealizedGainLossRate: totalInvestment.isZero()
				? 0
				: MoneyAmount.subtract(totalCurrentValue, totalInvestment)
						.divide(totalInvestment)
						.multiply(100).value,
			composition: compositions
		});
	}

	private async getOrCreateStock(symbol: string): Promise<Stock> {
		let stock = await this.stockRepository.findBySymbol(symbol);

		if (!stock) {
			const stockInfo = await this.stockPriceService.getStockInfo(symbol);
			stock = Stock.create({
				symbol: stockInfo.symbol,
				name: stockInfo.name,
				exchange: stockInfo.exchange,
				currency: stockInfo.currency
			});
			await this.stockRepository.save(stock);
		}

		return stock;
	}
}
```

---

## 4. ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ã‚¯ãƒ©ã‚¹æ§‹é€ 

### 4.1 RepositoryåŸºåº•ã‚¯ãƒ©ã‚¹

```typescript
// src/shared/infrastructure/base-repository.ts

/**
 * RepositoryåŸºåº•ã‚¯ãƒ©ã‚¹
 */
export abstract class BaseRepository<TEntity extends { id: EntityId }> {
	constructor(
		protected readonly prisma: PrismaClient,
		protected readonly logger: Logger
	) {}

	protected async executeQuery<T>(operation: string, query: () => Promise<T>): Promise<T> {
		const startTime = Date.now();

		try {
			const result = await query();
			const duration = Date.now() - startTime;

			this.logger.debug(`Repository query executed`, {
				operation,
				duration
			});

			return result;
		} catch (error) {
			const duration = Date.now() - startTime;

			this.logger.error(`Repository query failed`, {
				operation,
				duration,
				error
			});

			throw error;
		}
	}

	protected abstract toDomain(raw: any): TEntity;
	protected abstract toPersistence(entity: TEntity): any;
}
```

### 4.2 çµ¦æ–™æ˜ç´°Repositoryå®Ÿè£…

```typescript
// src/features/salary-slip/infrastructure/salary-slip.repository.ts

/**
 * çµ¦æ–™æ˜ç´°Repositoryå®Ÿè£…
 */
export class PrismaSalarySlipRepository
	extends BaseRepository<SalarySlip>
	implements SalarySlipRepository
{
	async save(salarySlip: SalarySlip): Promise<void> {
		return this.executeQuery('save', async () => {
			const data = this.toPersistence(salarySlip);

			await this.prisma.salarySlip.upsert({
				where: { id: salarySlip.id.value },
				create: data,
				update: data
			});
		});
	}

	async findById(id: EntityId): Promise<SalarySlip | null> {
		return this.executeQuery('findById', async () => {
			const raw = await this.prisma.salarySlip.findUnique({
				where: { id: id.value },
				include: {
					earnings: true,
					deductions: true,
					attendance: true
				}
			});

			return raw ? this.toDomain(raw) : null;
		});
	}

	async findByUserId(
		userId: EntityId,
		pagination: PaginationOptions
	): Promise<PaginatedResult<SalarySlip>> {
		return this.executeQuery('findByUserId', async () => {
			const [data, total] = await Promise.all([
				this.prisma.salarySlip.findMany({
					where: { userId: userId.value },
					include: {
						earnings: true,
						deductions: true,
						attendance: true
					},
					skip: (pagination.page - 1) * pagination.limit,
					take: pagination.limit,
					orderBy: { paymentDate: 'desc' }
				}),
				this.prisma.salarySlip.count({
					where: { userId: userId.value }
				})
			]);

			return new PaginatedResult(
				data.map((raw) => this.toDomain(raw)),
				total,
				pagination
			);
		});
	}

	async findBySpecification(
		userId: EntityId,
		specification: SalarySlipSpecification
	): Promise<PaginatedResult<SalarySlip>> {
		return this.executeQuery('findBySpecification', async () => {
			const whereClause = this.buildWhereClause(userId, specification);

			const [data, total] = await Promise.all([
				this.prisma.salarySlip.findMany({
					where: whereClause,
					include: {
						earnings: true,
						deductions: true,
						attendance: true
					},
					skip: (specification.pagination.page - 1) * specification.pagination.limit,
					take: specification.pagination.limit,
					orderBy: { [specification.sortBy]: specification.sortOrder }
				}),
				this.prisma.salarySlip.count({
					where: whereClause
				})
			]);

			return new PaginatedResult(
				data.map((raw) => this.toDomain(raw)),
				total,
				specification.pagination
			);
		});
	}

	async findByPaymentDate(userId: EntityId, paymentDate: Date): Promise<SalarySlip | null> {
		return this.executeQuery('findByPaymentDate', async () => {
			const raw = await this.prisma.salarySlip.findFirst({
				where: {
					userId: userId.value,
					paymentDate: {
						gte: new Date(paymentDate.getFullYear(), paymentDate.getMonth(), paymentDate.getDate()),
						lt: new Date(
							paymentDate.getFullYear(),
							paymentDate.getMonth(),
							paymentDate.getDate() + 1
						)
					}
				},
				include: {
					earnings: true,
					deductions: true,
					attendance: true
				}
			});

			return raw ? this.toDomain(raw) : null;
		});
	}

	protected toDomain(raw: any): SalarySlip {
		return SalarySlip.reconstitute({
			id: EntityId.from(raw.id),
			userId: EntityId.from(raw.userId),
			companyName: raw.companyName,
			employeeName: raw.employeeName,
			employeeId: raw.employeeId,
			paymentDate: raw.paymentDate,
			targetPeriodStart: raw.targetPeriodStart,
			targetPeriodEnd: raw.targetPeriodEnd,
			attendance: AttendanceInfo.create({
				overtimeHours: raw.attendance.overtimeHours,
				overtimeHoursOver60: raw.attendance.overtimeHoursOver60,
				lateNightHours: raw.attendance.lateNightHours,
				holidayWorkDays: raw.attendance.holidayWorkDays,
				paidLeaveDays: raw.attendance.paidLeaveDays,
				absenceDays: raw.attendance.absenceDays,
				workingDays: raw.attendance.workingDays,
				scheduledWorkDays: raw.attendance.scheduledWorkDays,
				lateCount: raw.attendance.lateCount,
				earlyLeaveCount: raw.attendance.earlyLeaveCount
			}),
			earnings: EarningsDetail.create({
				baseSalary: raw.earnings.baseSalary.toString(),
				overtimePay: raw.earnings.overtimePay.toString(),
				overtimePayOver60: raw.earnings.overtimePayOver60.toString(),
				lateNightPay: raw.earnings.lateNightPay.toString(),
				holidayWorkPay: raw.earnings.holidayWorkPay.toString(),
				fixedOvertimeAllowance: raw.earnings.fixedOvertimeAllowance.toString(),
				transportationAllowance: raw.earnings.transportationAllowance.toString(),
				housingAllowance: raw.earnings.housingAllowance.toString(),
				familyAllowance: raw.earnings.familyAllowance.toString(),
				qualificationAllowance: raw.earnings.qualificationAllowance.toString(),
				expenseReimbursement: raw.earnings.expenseReimbursement.toString(),
				stockPurchaseIncentive: raw.earnings.stockPurchaseIncentive.toString(),
				bonus: raw.earnings.bonus.toString(),
				otherEarnings: raw.earnings.otherEarnings.toString()
			}),
			deductions: DeductionsDetail.create({
				healthInsurance: raw.deductions.healthInsurance.toString(),
				welfareInsurance: raw.deductions.welfareInsurance.toString(),
				employmentInsurance: raw.deductions.employmentInsurance.toString(),
				incomeTax: raw.deductions.incomeTax.toString(),
				residentTax: raw.deductions.residentTax.toString(),
				stockPurchase: raw.deductions.stockPurchase.toString(),
				loan: raw.deductions.loan.toString(),
				unionFee: raw.deductions.unionFee.toString(),
				otherDeductions: raw.deductions.otherDeductions.toString()
			}),
			currency: raw.currency,
			status: raw.status,
			sourceType: raw.sourceType,
			createdAt: raw.createdAt,
			updatedAt: raw.updatedAt
		});
	}

	protected toPersistence(salarySlip: SalarySlip): any {
		return {
			id: salarySlip.id.value,
			userId: salarySlip.userId.value,
			companyName: salarySlip.companyName,
			employeeName: salarySlip.employeeName,
			employeeId: salarySlip.employeeId,
			paymentDate: salarySlip.paymentDate,
			targetPeriodStart: salarySlip.targetPeriod.start,
			targetPeriodEnd: salarySlip.targetPeriod.end,
			baseSalary: new Prisma.Decimal(salarySlip.earnings.baseSalary.value),
			totalEarnings: new Prisma.Decimal(salarySlip.totalEarnings.value),
			totalDeductions: new Prisma.Decimal(salarySlip.totalDeductions.value),
			netPay: new Prisma.Decimal(salarySlip.netPay.value),
			currency: salarySlip.currency,
			status: salarySlip.status,
			sourceType: salarySlip.sourceType,
			createdAt: salarySlip.createdAt,
			updatedAt: salarySlip.updatedAt,
			attendance: {
				upsert: {
					create: {
						overtimeHours: salarySlip.attendance.overtimeHours,
						overtimeHoursOver60: salarySlip.attendance.overtimeHoursOver60,
						lateNightHours: salarySlip.attendance.lateNightHours,
						holidayWorkDays: salarySlip.attendance.holidayWorkDays,
						paidLeaveDays: salarySlip.attendance.paidLeaveDays,
						absenceDays: salarySlip.attendance.absenceDays,
						workingDays: salarySlip.attendance.workingDays,
						scheduledWorkDays: salarySlip.attendance.scheduledWorkDays,
						lateCount: salarySlip.attendance.lateCount,
						earlyLeaveCount: salarySlip.attendance.earlyLeaveCount
					},
					update: {
						overtimeHours: salarySlip.attendance.overtimeHours,
						overtimeHoursOver60: salarySlip.attendance.overtimeHoursOver60,
						lateNightHours: salarySlip.attendance.lateNightHours,
						holidayWorkDays: salarySlip.attendance.holidayWorkDays,
						paidLeaveDays: salarySlip.attendance.paidLeaveDays,
						absenceDays: salarySlip.attendance.absenceDays,
						workingDays: salarySlip.attendance.workingDays,
						scheduledWorkDays: salarySlip.attendance.scheduledWorkDays,
						lateCount: salarySlip.attendance.lateCount,
						earlyLeaveCount: salarySlip.attendance.earlyLeaveCount
					}
				}
			},
			earnings: {
				upsert: {
					create: this.earningsToPersistence(salarySlip.earnings),
					update: this.earningsToPersistence(salarySlip.earnings)
				}
			},
			deductions: {
				upsert: {
					create: this.deductionsToPersistence(salarySlip.deductions),
					update: this.deductionsToPersistence(salarySlip.deductions)
				}
			}
		};
	}

	private buildWhereClause(userId: EntityId, specification: SalarySlipSpecification): any {
		const where: any = {
			userId: userId.value
		};

		if (specification.status) {
			where.status = specification.status;
		}

		if (specification.companyName) {
			where.companyName = {
				contains: specification.companyName,
				mode: 'insensitive'
			};
		}

		if (specification.dateRange) {
			where.paymentDate = {
				gte: specification.dateRange.start,
				lte: specification.dateRange.end
			};
		}

		if (specification.amountRange) {
			where.netPay = {
				gte: new Prisma.Decimal(specification.amountRange.min.value),
				lte: new Prisma.Decimal(specification.amountRange.max.value)
			};
		}

		if (specification.searchQuery) {
			where.OR = [
				{ companyName: { contains: specification.searchQuery, mode: 'insensitive' } },
				{ employeeName: { contains: specification.searchQuery, mode: 'insensitive' } },
				{ employeeId: { contains: specification.searchQuery, mode: 'insensitive' } }
			];
		}

		return where;
	}

	private earningsToPersistence(earnings: EarningsDetail): any {
		return {
			baseSalary: new Prisma.Decimal(earnings.baseSalary.value),
			overtimePay: new Prisma.Decimal(earnings.overtimePay.value),
			overtimePayOver60: new Prisma.Decimal(earnings.overtimePayOver60.value),
			lateNightPay: new Prisma.Decimal(earnings.lateNightPay.value),
			holidayWorkPay: new Prisma.Decimal(earnings.holidayWorkPay.value),
			fixedOvertimeAllowance: new Prisma.Decimal(earnings.fixedOvertimeAllowance.value),
			transportationAllowance: new Prisma.Decimal(earnings.transportationAllowance.value),
			housingAllowance: new Prisma.Decimal(earnings.housingAllowance.value),
			familyAllowance: new Prisma.Decimal(earnings.familyAllowance.value),
			qualificationAllowance: new Prisma.Decimal(earnings.qualificationAllowance.value),
			expenseReimbursement: new Prisma.Decimal(earnings.expenseReimbursement.value),
			stockPurchaseIncentive: new Prisma.Decimal(earnings.stockPurchaseIncentive.value),
			bonus: new Prisma.Decimal(earnings.bonus.value),
			otherEarnings: new Prisma.Decimal(earnings.otherEarnings.value)
		};
	}

	private deductionsToPersistence(deductions: DeductionsDetail): any {
		return {
			healthInsurance: new Prisma.Decimal(deductions.healthInsurance.value),
			welfareInsurance: new Prisma.Decimal(deductions.welfareInsurance.value),
			employmentInsurance: new Prisma.Decimal(deductions.employmentInsurance.value),
			incomeTax: new Prisma.Decimal(deductions.incomeTax.value),
			residentTax: new Prisma.Decimal(deductions.residentTax.value),
			stockPurchase: new Prisma.Decimal(deductions.stockPurchase.value),
			loan: new Prisma.Decimal(deductions.loan.value),
			unionFee: new Prisma.Decimal(deductions.unionFee.value),
			otherDeductions: new Prisma.Decimal(deductions.otherDeductions.value)
		};
	}
}
```

---

## 5. å…±æœ‰å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

### 5.1 åŸºæœ¬å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

```typescript
// src/shared/domain/value-objects/entity-id.ts

/**
 * ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£IDå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
export class EntityId {
	private readonly _value: string;

	private constructor(value: string) {
		if (!value || value.trim().length === 0) {
			throw new EntityIdError('Entity ID cannot be empty');
		}
		if (value.length !== 25) {
			// CUID length
			throw new EntityIdError('Entity ID must be 25 characters long');
		}
		this._value = value;
	}

	public static from(value: string): EntityId {
		return new EntityId(value);
	}

	public static generate(): EntityId {
		return new EntityId(cuid());
	}

	public get value(): string {
		return this._value;
	}

	public equals(other: EntityId): boolean {
		return this._value === other._value;
	}

	public toString(): string {
		return this._value;
	}
}
```

```typescript
// src/shared/domain/value-objects/money-amount.ts

/**
 * é‡‘é¡å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
export class MoneyAmount {
	private readonly _value: Decimal;

	private constructor(value: Decimal) {
		if (value.isNaN()) {
			throw new MoneyAmountError('Money amount cannot be NaN');
		}
		if (!value.isFinite()) {
			throw new MoneyAmountError('Money amount must be finite');
		}
		this._value = value.toDP(2); // å°æ•°ç‚¹ä»¥ä¸‹2æ¡ã§å›ºå®š
	}

	public static from(value: string | number): MoneyAmount {
		try {
			return new MoneyAmount(new Decimal(value));
		} catch (error) {
			throw new MoneyAmountError(`Invalid money amount: ${value}`);
		}
	}

	public static zero(): MoneyAmount {
		return new MoneyAmount(new Decimal(0));
	}

	public static sum(amounts: MoneyAmount[]): MoneyAmount {
		const total = amounts.reduce((acc, amount) => acc.add(amount._value), new Decimal(0));
		return new MoneyAmount(total);
	}

	public static add(a: MoneyAmount, b: MoneyAmount): MoneyAmount {
		return new MoneyAmount(a._value.add(b._value));
	}

	public static subtract(a: MoneyAmount, b: MoneyAmount): MoneyAmount {
		return new MoneyAmount(a._value.sub(b._value));
	}

	public static multiply(amount: MoneyAmount, multiplier: number): MoneyAmount {
		return new MoneyAmount(amount._value.mul(multiplier));
	}

	public static divide(amount: MoneyAmount, divisor: number): MoneyAmount {
		if (divisor === 0) {
			throw new MoneyAmountError('Cannot divide by zero');
		}
		return new MoneyAmount(amount._value.div(divisor));
	}

	public add(other: MoneyAmount): MoneyAmount {
		return MoneyAmount.add(this, other);
	}

	public subtract(other: MoneyAmount): MoneyAmount {
		return MoneyAmount.subtract(this, other);
	}

	public multiply(multiplier: number): MoneyAmount {
		return MoneyAmount.multiply(this, multiplier);
	}

	public divide(divisor: number): MoneyAmount {
		return MoneyAmount.divide(this, divisor);
	}

	public isZero(): boolean {
		return this._value.isZero();
	}

	public isPositive(): boolean {
		return this._value.gt(0);
	}

	public isNegative(): boolean {
		return this._value.lt(0);
	}

	public equals(other: MoneyAmount): boolean {
		return this._value.equals(other._value);
	}

	public get value(): string {
		return this._value.toString();
	}

	public toNumber(): number {
		return this._value.toNumber();
	}

	public toString(): string {
		return this._value.toString();
	}
}
```

```typescript
// src/shared/domain/value-objects/email.ts

/**
 * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
export class Email {
	private readonly _value: string;

	private constructor(value: string) {
		if (!this.isValid(value)) {
			throw new EmailError(`Invalid email format: ${value}`);
		}
		this._value = value.toLowerCase();
	}

	public static from(value: string): Email {
		return new Email(value);
	}

	private isValid(email: string): boolean {
		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		return emailRegex.test(email) && email.length <= 254;
	}

	public get value(): string {
		return this._value;
	}

	public get domain(): string {
		return this._value.split('@')[1];
	}

	public get localPart(): string {
		return this._value.split('@')[0];
	}

	public equals(other: Email): boolean {
		return this._value === other._value;
	}

	public toString(): string {
		return this._value;
	}
}
```

---

## 6. ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹éšå±¤

### 6.1 åŸºåº•ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹

```typescript
// src/shared/domain/errors/base-error.ts

/**
 * ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼åŸºåº•ã‚¯ãƒ©ã‚¹
 */
export abstract class DomainError extends Error {
	protected constructor(
		message: string,
		public readonly code: string,
		public readonly details?: Record<string, any>
	) {
		super(message);
		this.name = this.constructor.name;
		Error.captureStackTrace(this, this.constructor);
	}

	abstract get statusCode(): number;
	abstract get userMessage(): string;
}

/**
 * ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
 */
export class ValidationError extends DomainError {
	constructor(
		message: string,
		public readonly field?: string,
		public readonly value?: any
	) {
		super(message, 'VALIDATION_ERROR', { field, value });
	}

	get statusCode(): number {
		return 400;
	}

	get userMessage(): string {
		return this.message;
	}
}

/**
 * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼
 */
export class BusinessRuleError extends DomainError {
	constructor(message: string, code: string, details?: Record<string, any>) {
		super(message, code, details);
	}

	get statusCode(): number {
		return 422;
	}

	get userMessage(): string {
		return this.message;
	}
}

/**
 * ãƒªã‚½ãƒ¼ã‚¹æœªç™ºè¦‹ã‚¨ãƒ©ãƒ¼
 */
export class NotFoundError extends DomainError {
	constructor(resource: string, identifier: string) {
		super(`${resource} not found: ${identifier}`, 'NOT_FOUND', { resource, identifier });
	}

	get statusCode(): number {
		return 404;
	}

	get userMessage(): string {
		return 'æŒ‡å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
	}
}
```

### 6.2 ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã‚¨ãƒ©ãƒ¼

```typescript
// src/entities/salary-slip/model/salary-slip.error.ts

/**
 * çµ¦æ–™æ˜ç´°ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼
 */
export class SalarySlipError extends BusinessRuleError {
	constructor(message: string, details?: Record<string, any>) {
		super(message, 'SALARY_SLIP_ERROR', details);
	}
}

export class SalarySlipNotFoundError extends NotFoundError {
	constructor(id: EntityId) {
		super('SalarySlip', id.value);
	}
}

export class DuplicateSalarySlipError extends BusinessRuleError {
	constructor(userId: EntityId, paymentDate: Date) {
		super('åŒã˜æ”¯æ‰•æ—¥ã®çµ¦æ–™æ˜ç´°ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™', 'DUPLICATE_SALARY_SLIP', {
			userId: userId.value,
			paymentDate: paymentDate.toISOString()
		});
	}
}
```

---

## 7. ã‚¯ãƒ©ã‚¹é–¢ä¿‚å›³

### 7.1 ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã‚¯ãƒ©ã‚¹å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Domain Layer                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   User       â”‚    â”‚   SalarySlip    â”‚    â”‚   StockPortfolio        â”‚ â”‚
â”‚  â”‚   Entity     â”‚    â”‚   Entity        â”‚    â”‚   Entity                â”‚ â”‚
â”‚  â”‚              â”‚    â”‚                 â”‚    â”‚                         â”‚ â”‚
â”‚  â”‚ + id         â”‚    â”‚ + id            â”‚    â”‚ + id                    â”‚ â”‚
â”‚  â”‚ + email      â”‚    â”‚ + userId        â”‚    â”‚ + userId                â”‚ â”‚
â”‚  â”‚ + name       â”‚â”€â”€â”€â”€â”‚ + companyName   â”‚    â”‚ + stockId               â”‚ â”‚
â”‚  â”‚ + preferencesâ”‚    â”‚ + earnings      â”‚    â”‚ + quantity              â”‚ â”‚
â”‚  â”‚              â”‚    â”‚ + deductions    â”‚    â”‚ + averagePurchasePrice  â”‚ â”‚
â”‚  â”‚ + updateProfile() â”‚ + calculateNetPay() â”‚ + processBuyTransaction() â”‚ â”‚
â”‚  â”‚ + verifyEmail()â”‚  â”‚ + confirm()     â”‚    â”‚ + processSellTransactionâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                       â”‚                         â”‚             â”‚
â”‚         â”‚                       â”‚                         â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚UserPreferencesâ”‚  â”‚   EarningsDetail   â”‚   â”‚  StockTransaction     â”‚  â”‚
â”‚  â”‚Value Object  â”‚   â”‚   Value Object     â”‚   â”‚  Entity               â”‚  â”‚
â”‚  â”‚              â”‚   â”‚                    â”‚   â”‚                       â”‚  â”‚
â”‚  â”‚+ defaultCurrencyâ”‚ â”‚ + baseSalary      â”‚   â”‚ + transactionType     â”‚  â”‚
â”‚  â”‚+ fiscalYearStartâ”‚ â”‚ + overtimePay     â”‚   â”‚ + quantity            â”‚  â”‚
â”‚  â”‚+ salaryDayOfMonthâ”‚â”‚ + allowances      â”‚   â”‚ + pricePerShare       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ + calculateTotal()â”‚   â”‚ + totalAmount         â”‚  â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Shared Value Objects                             â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  EntityId    â”‚  â”‚  MoneyAmount    â”‚  â”‚       Email             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚              â”‚  â”‚                 â”‚  â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ + value      â”‚  â”‚ + value         â”‚  â”‚ + value                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ + generate() â”‚  â”‚ + add()         â”‚  â”‚ + domain                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ + equals()   â”‚  â”‚ + subtract()    â”‚  â”‚ + equals()              â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ + multiply()    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                    â”‚ + divide()      â”‚                              â”‚ â”‚
â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã‚¯ãƒ©ã‚¹å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Application Layer                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚   BaseService   â”‚                                                    â”‚
â”‚  â”‚   Abstract      â”‚                                                    â”‚
â”‚  â”‚                 â”‚                                                    â”‚
â”‚  â”‚ + logger        â”‚                                                    â”‚
â”‚  â”‚ + eventBus      â”‚                                                    â”‚
â”‚  â”‚ + unitOfWork    â”‚                                                    â”‚
â”‚  â”‚                 â”‚                                                    â”‚
â”‚  â”‚ + executeInTransaction()                                             â”‚ â”‚
â”‚  â”‚ + publishEvent()â”‚                                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚          â–²                                                              â”‚
â”‚          â”‚                                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚    â”‚           â”‚                             â”‚                         â”‚â”‚
â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚ â”‚SalarySlip  â”‚ â”‚ â”‚    PortfolioService     â”‚ â”‚  â”‚    UserService      â”‚â”‚â”‚
â”‚ â”‚Service     â”‚ â”‚ â”‚                         â”‚ â”‚  â”‚                     â”‚â”‚â”‚
â”‚ â”‚            â”‚ â”‚ â”‚ + processTransaction()  â”‚ â”‚  â”‚ + createUser()      â”‚â”‚â”‚
â”‚ â”‚+ createFromPdf() â”‚ + getPortfolioSummary()â”‚ â”‚  â”‚ + updateProfile()   â”‚â”‚â”‚
â”‚ â”‚+ findByUserId()â”‚ â”‚ + updateStockPrices() â”‚ â”‚  â”‚ + verifyEmail()     â”‚â”‚â”‚
â”‚ â”‚+ getStatistics()â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ + recordLogin()     â”‚â”‚â”‚
â”‚ â”‚+ confirm()  â”‚                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚                         â”‚â”‚
â”‚       â”‚                                      â”‚                         â”‚â”‚
â”‚       â”‚                                      â”‚                         â”‚â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚ â”‚SalarySlipRepositoryâ”‚                     â”‚  UserRepository        â”‚  â”‚â”‚
â”‚ â”‚Interface          â”‚                      â”‚  Interface             â”‚  â”‚â”‚
â”‚ â”‚                   â”‚                      â”‚                        â”‚  â”‚â”‚
â”‚ â”‚+ save()           â”‚                      â”‚ + save()               â”‚  â”‚â”‚
â”‚ â”‚+ findById()       â”‚                      â”‚ + findById()           â”‚  â”‚â”‚
â”‚ â”‚+ findByUserId()   â”‚                      â”‚ + findByEmail()        â”‚  â”‚â”‚
â”‚ â”‚+ findBySpecification()                   â”‚ + findByGoogleId()     â”‚  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ã‚¯ãƒ©ã‚¹å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Infrastructure Layer                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   BaseRepository                                    â”‚ â”‚
â”‚  â”‚                   Abstract Class                                    â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ + prisma: PrismaClient                                             â”‚ â”‚
â”‚  â”‚ + logger: Logger                                                   â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ + executeQuery<T>(operation, query): Promise<T>                     â”‚ â”‚
â”‚  â”‚ # toDomain(raw): TEntity                                           â”‚ â”‚
â”‚  â”‚ # toPersistence(entity): any                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â–²                                    â”‚
â”‚                                    â”‚                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                               â”‚                                   â”‚ â”‚
â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚ â”‚PrismaSalarySlipRepository â”‚   â”‚  PrismaStockPortfolioRepository â”‚    â”‚ â”‚
â”‚ â”‚                          â”‚   â”‚                                  â”‚    â”‚ â”‚
â”‚ â”‚+ save()                  â”‚   â”‚ + save()                         â”‚    â”‚ â”‚
â”‚ â”‚+ findById()              â”‚   â”‚ + findById()                     â”‚    â”‚ â”‚
â”‚ â”‚+ findByUserId()          â”‚   â”‚ + findByUserIdAndStockId()       â”‚    â”‚ â”‚
â”‚ â”‚+ findBySpecification()   â”‚   â”‚ + findByUserId()                 â”‚    â”‚ â”‚
â”‚ â”‚+ findByPaymentDate()     â”‚   â”‚                                  â”‚    â”‚ â”‚
â”‚ â”‚                          â”‚   â”‚ # toDomain()                     â”‚    â”‚ â”‚
â”‚ â”‚# toDomain()              â”‚   â”‚ # toPersistence()                â”‚    â”‚ â”‚
â”‚ â”‚# toPersistence()         â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚ â”‚# buildWhereClause()      â”‚                                           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚ â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    External Services                                â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ PdfParserServiceâ”‚  â”‚ StockPriceServiceâ”‚  â”‚ NotificationService â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                  â”‚  â”‚                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ + extract()     â”‚  â”‚ + getCurrentPriceâ”‚  â”‚ + sendEmail()       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ + validate()    â”‚  â”‚ + getHistoricalPrices â”‚ + sendPush()      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ + getStockInfo() â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ä¾å­˜é–¢ä¿‚ã¨ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

### 8.1 ä¾å­˜æ€§æ³¨å…¥è¨­å®š

```typescript
// src/shared/infrastructure/di/container.ts
/**
 * DI ã‚³ãƒ³ãƒ†ãƒŠè¨­å®š
 */
import type { SalarySlipRepository, StockPortfolioRepository, UserRepository } from '../interfaces';

import { Container } from 'inversify';

const container = new Container();

// Repositories
container
	.bind<SalarySlipRepository>('SalarySlipRepository')
	.to(PrismaSalarySlipRepository)
	.inSingletonScope();

container
	.bind<StockPortfolioRepository>('StockPortfolioRepository')
	.to(PrismaStockPortfolioRepository)
	.inSingletonScope();

container.bind<UserRepository>('UserRepository').to(PrismaUserRepository).inSingletonScope();

// Services
container.bind<SalarySlipService>('SalarySlipService').to(SalarySlipService).inTransientScope();

container.bind<PortfolioService>('PortfolioService').to(PortfolioService).inTransientScope();

// Infrastructure Services
container
	.bind<PdfParserService>('PdfParserService')
	.to(TesseractPdfParserService)
	.inSingletonScope();

container
	.bind<StockPriceService>('StockPriceService')
	.to(AlphaVantageStockPriceService)
	.inSingletonScope();

container.bind<Logger>('Logger').to(WinstonLogger).inSingletonScope();

container.bind<EventBus>('EventBus').to(InMemoryEventBus).inSingletonScope();

container.bind<UnitOfWork>('UnitOfWork').to(PrismaUnitOfWork).inTransientScope();

export { container };
```

### 8.2 ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

```typescript
// src/shared/infrastructure/lifecycle/application-lifecycle.ts

/**
 * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
 */
export class ApplicationLifecycleManager {
	private readonly logger: Logger;
	private readonly prisma: PrismaClient;
	private readonly eventBus: EventBus;

	constructor(logger: Logger, prisma: PrismaClient, eventBus: EventBus) {
		this.logger = logger;
		this.prisma = prisma;
		this.eventBus = eventBus;
	}

	async initialize(): Promise<void> {
		this.logger.info('Initializing application...');

		try {
			// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
			await this.prisma.$connect();
			this.logger.info('Database connection established');

			// ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹åˆæœŸåŒ–
			await this.eventBus.initialize();
			this.logger.info('Event bus initialized');

			// å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
			await this.checkExternalServices();

			this.logger.info('Application initialized successfully');
		} catch (error) {
			this.logger.error('Failed to initialize application', { error });
			throw error;
		}
	}

	async shutdown(): Promise<void> {
		this.logger.info('Shutting down application...');

		try {
			// ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†å®Œäº†å¾…ã¡
			await this.eventBus.flush();
			this.logger.info('Event bus flushed');

			// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¯ãƒ­ãƒ¼ã‚º
			await this.prisma.$disconnect();
			this.logger.info('Database connection closed');

			this.logger.info('Application shutdown completed');
		} catch (error) {
			this.logger.error('Error during application shutdown', { error });
			throw error;
		}
	}

	private async checkExternalServices(): Promise<void> {
		// å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯å®Ÿè£…
		// æ ªä¾¡APIã€PDFè§£æã‚µãƒ¼ãƒ“ã‚¹ãªã©ã®æ¥ç¶šç¢ºèª
	}
}
```

---

## 9. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… ã‚¯ãƒ©ã‚¹æ§‹é€ è¨­è¨ˆï¼ˆæœ¬æ›¸ï¼‰
2. â†’ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆï¼ˆServiceå±¤ãƒ»Repositoryå±¤ï¼‰
3. â†’ ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨è¨­è¨ˆ
4. â†’ å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ä½œæˆ
5. â†’ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæˆ¦ç•¥å®šç¾©
6. â†’ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æŒ‡é‡

---

## æ‰¿èª

| å½¹å‰²                   | åå‰                   | æ—¥ä»˜       | ç½²å |
| ---------------------- | ---------------------- | ---------- | ---- |
| ã‚¯ãƒ©ã‚¹è¨­è¨ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ | ã‚¯ãƒ©ã‚¹è¨­è¨ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ | 2025-08-10 | âœ…   |
| ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼             | -                      | -          | [ ]  |
| æ‰¿èªè€…                 | -                      | -          | [ ]  |

---

**æ”¹è¨‚å±¥æ­´**

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜       | å¤‰æ›´å†…å®¹ | ä½œæˆè€…                 |
| ---------- | ---------- | -------- | ---------------------- |
| 1.0.0      | 2025-08-10 | åˆç‰ˆä½œæˆ | ã‚¯ãƒ©ã‚¹è¨­è¨ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ |
