# ユーザーストーリー仕様書

## Phase 1 (MVP) ユーザーストーリー

### US-001: 給料明細のアップロード

**As a** 個人投資家  
**I want to** 給料明細のPDFをアップロードする  
**So that** 収入データを自動的にシステムに取り込める

#### 受け入れ基準（シナリオ形式）

**シナリオ1: 正常なPDFアップロード**

```gherkin
Given ユーザーが給料明細アップロード画面を開いている
When 有効なPDFファイルをドラッグ&ドロップする
Then アップロード進捗バーが表示される
And PDFの内容が自動的に解析される
And 抽出されたデータがプレビュー表示される
And ユーザーは内容を確認・編集できる
And 「保存」ボタンをクリックすると、データがデータベースに保存される
```

**シナリオ2: 複数ファイルの一括アップロード**

```gherkin
Given ユーザーが給料明細アップロード画面を開いている
When 複数のPDFファイルを選択してアップロードする
Then 各ファイルの処理状況が個別に表示される
And 処理完了したファイルから順次プレビューが可能
And エラーが発生したファイルは赤色で表示される
And 成功したファイルのみ保存できる
```

**シナリオ3: 重複データの検出**

```gherkin
Given 2024年7月の給料明細が既に登録されている
When 同じ2024年7月のPDFをアップロードする
Then 重複警告メッセージが表示される
And ユーザーは「上書き」または「キャンセル」を選択できる
```

---

### US-002: 給料明細の一覧表示

**As a** 個人投資家  
**I want to** 過去の給料明細を一覧で確認する  
**So that** 収入の推移を把握できる

#### 受け入れ基準

```gherkin
Given 給料明細データが登録されている
When 給料明細一覧画面を開く
Then 年月順（新しい順）にソートされた一覧が表示される
And 各明細には「支給日」「手取り額」「総支給額」が表示される
And 明細をクリックすると詳細画面が開く
And 期間フィルター（年度・四半期）が利用できる
```

---

### US-003: 株式ポートフォリオの登録

**As a** 個人投資家  
**I want to** 保有株式を登録する  
**So that** ポートフォリオの時価評価を管理できる

#### 受け入れ基準

**シナリオ1: 新規株式の登録**

```gherkin
Given ユーザーがポートフォリオ管理画面を開いている
When 「新規登録」ボタンをクリックする
And 銘柄コード「7203」（トヨタ）を入力する
And 保有数「100」株を入力する
And 取得単価「2,500」円を入力する
And 取得日「2024-01-15」を選択する
And 「登録」ボタンをクリックする
Then 株式がポートフォリオ一覧に追加される
And 現在株価が自動取得される
And 評価損益が計算・表示される
```

**シナリオ2: 株式情報の編集**

```gherkin
Given 株式がポートフォリオに登録されている
When 一覧から編集したい株式の「編集」ボタンをクリックする
And 保有数を変更する
And 「更新」ボタンをクリックする
Then 変更内容が保存される
And 評価額が再計算される
```

---

### US-004: 株価の更新

**As a** 個人投資家  
**I want to** 最新の株価を取得する  
**So that** ポートフォリオの現在価値を把握できる

#### 受け入れ基準

```gherkin
Given ポートフォリオに株式が登録されている
When 「株価更新」ボタンをクリックする
Then 登録されている全銘柄の最新株価が取得される
And 更新中はローディング表示される
And 更新完了後、最終更新日時が表示される
And 各銘柄の評価損益が再計算される
And 更新エラーが発生した銘柄は警告表示される
```

---

### US-005: ダッシュボードの表示

**As a** 個人投資家  
**I want to** 資産の全体像をダッシュボードで確認する  
**So that** 財務状況を一目で把握できる

#### 受け入れ基準

```gherkin
Given 給料明細と株式ポートフォリオのデータが存在する
When ダッシュボード画面を開く
Then 以下の情報が表示される：
  - 総資産額（現金 + 株式評価額）
  - 今月の収入額
  - 株式ポートフォリオの評価損益
  - 貯蓄率
And 以下のグラフが表示される：
  - 月次収入推移（過去12ヶ月）
  - 資産推移グラフ
  - ポートフォリオ構成円グラフ
And 期間フィルターで表示期間を変更できる
```

---

### US-006: 収入推移の分析

**As a** 個人投資家  
**I want to** 収入の推移をグラフで確認する  
**So that** 収入の傾向や変動を把握できる

#### 受け入れ基準

```gherkin
Given 複数月の給料明細データが登録されている
When ダッシュボードの収入推移グラフを表示する
Then 棒グラフで月次収入が表示される
And 手取り額と総支給額の両方が表示される
And 平均値ラインが表示される
And グラフの期間を「3ヶ月」「6ヶ月」「1年」「全期間」から選択できる
And データポイントにカーソルを合わせると詳細金額が表示される
```

---

### US-007: ポートフォリオ構成の可視化

**As a** 個人投資家  
**I want to** ポートフォリオの構成比を確認する  
**So that** 資産配分のバランスを把握できる

#### 受け入れ基準

```gherkin
Given 複数の株式がポートフォリオに登録されている
When ポートフォリオ構成グラフを表示する
Then 円グラフで各銘柄の構成比が表示される
And 各セクターにカーソルを合わせると以下が表示される：
  - 銘柄名
  - 評価額
  - 構成比率（%）
  - 評価損益
And 凡例には上位5銘柄が表示される
And 「その他」でまとめられた銘柄も確認できる
```

---

## Phase 2 ユーザーストーリー

### US-008: データのエクスポート

**As a** 個人投資家  
**I want to** データをCSV形式でエクスポートする  
**So that** Excelなどで独自の分析ができる

#### 受け入れ基準

```gherkin
Given データが登録されている
When エクスポート機能を実行する
Then 期間を指定できる
And データ種別（給料明細/ポートフォリオ/両方）を選択できる
And CSVファイルがダウンロードされる
And ファイル名に日付が含まれる
```

---

### US-009: 予算の設定と追跡

**As a** 個人投資家  
**I want to** 月次予算を設定して実績と比較する  
**So that** 支出をコントロールできる

#### 受け入れ基準

```gherkin
Given ユーザーが予算管理画面を開いている
When 月次予算を設定する
Then カテゴリ別に予算を入力できる
And 実績が自動的に集計される
And 予算対比がグラフで表示される
And 予算超過時に警告が表示される
```

---

## Phase 3 ユーザーストーリー

### US-010: 投資シミュレーション

**As a** 個人投資家  
**I want to** 将来の資産をシミュレーションする  
**So that** 投資計画を立てられる

#### 受け入れ基準

```gherkin
Given シミュレーション画面を開いている
When パラメータを入力する：
  - 毎月の投資額
  - 想定利回り
  - 投資期間
Then 将来の資産推移グラフが表示される
And 複利効果が可視化される
And 複数シナリオを比較できる
```

---

## エラーシナリオ（全ストーリー共通）

### エラー処理の基本パターン

```gherkin
Given 任意の操作を実行中
When エラーが発生する
Then 以下の処理が行われる：
  - ユーザーフレンドリーなエラーメッセージが表示される
  - 詳細エラー情報はコンソールログに記録される
  - 可能な場合はリトライオプションが提供される
  - データの不整合は発生しない
```

### 主要なエラーケース

1. **ファイルアップロードエラー**
   - 非対応ファイル形式
   - ファイルサイズ超過
   - 破損ファイル

2. **API通信エラー**
   - ネットワーク接続エラー
   - タイムアウト
   - 認証エラー

3. **データ検証エラー**
   - 必須項目の未入力
   - 不正な値の入力
   - 重複データ

4. **外部サービスエラー**
   - 株価API接続エラー
   - レート制限超過

---

## テストシナリオ例

### 統合テストシナリオ: 初回利用フロー

```gherkin
Feature: 初回利用者の基本フロー

Scenario: 新規ユーザーが初めてシステムを利用する
  Given ユーザーが初めてシステムにアクセスする

  # 給料明細の登録
  When 給料明細アップロード画面に移動する
  And 過去3ヶ月分のPDFをアップロードする
  Then データが正常に登録される

  # 株式の登録
  When ポートフォリオ管理画面に移動する
  And 保有株式を2銘柄登録する
  Then ポートフォリオが作成される

  # ダッシュボード確認
  When ダッシュボードに移動する
  Then 総資産が表示される
  And 収入推移グラフが表示される
  And ポートフォリオ構成が表示される
```

---

## 優先度マトリックス

| ストーリーID | 機能             | ビジネス価値 | 技術的複雑度 | 優先度   |
| ------------ | ---------------- | ------------ | ------------ | -------- |
| US-001       | PDF取込          | 高           | 高           | 必須     |
| US-002       | 明細一覧         | 高           | 低           | 必須     |
| US-003       | 株式登録         | 高           | 中           | 必須     |
| US-004       | 株価更新         | 高           | 中           | 必須     |
| US-005       | ダッシュボード   | 高           | 中           | 必須     |
| US-006       | 収入分析         | 中           | 低           | 必須     |
| US-007       | 構成可視化       | 中           | 低           | 必須     |
| US-008       | エクスポート     | 中           | 低           | 推奨     |
| US-009       | 予算管理         | 中           | 中           | 推奨     |
| US-010       | シミュレーション | 低           | 高           | できれば |
