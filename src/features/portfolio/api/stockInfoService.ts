/**
 * è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã‹ã‚‰éŠ˜æŸ„æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹
 */
import { getStockInfoFromStooq } from './stooqApiService';

export interface StockInfo {
	symbol: string;
	name: string;
	market?: string;
}

/**
 * æ—¥æœ¬ã®ä¸»è¦éŠ˜æŸ„ã®è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã¨éŠ˜æŸ„åã®ãƒãƒƒãƒ”ãƒ³ã‚°
 * å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯å¤–éƒ¨APIã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
 */
const STOCK_INFO_MAP: Record<string, StockInfo> = {
	// è‡ªå‹•è»Šãƒ»è¼¸é€æ©Ÿ
	'7203': { symbol: '7203', name: 'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'7267': { symbol: '7267', name: 'ãƒ›ãƒ³ãƒ€', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'7201': { symbol: '7201', name: 'æ—¥ç”£è‡ªå‹•è»Š', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'7261': { symbol: '7261', name: 'ãƒãƒ„ãƒ€', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'7270': { symbol: '7270', name: 'SUBARU', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// é›»æ°—æ©Ÿå™¨
	'6758': { symbol: '6758', name: 'ã‚½ãƒ‹ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'6861': { symbol: '6861', name: 'ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'6501': { symbol: '6501', name: 'æ—¥ç«‹è£½ä½œæ‰€', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'6954': { symbol: '6954', name: 'ãƒ•ã‚¡ãƒŠãƒƒã‚¯', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'6752': { symbol: '6752', name: 'ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'6902': { symbol: '6902', name: 'ãƒ‡ãƒ³ã‚½ãƒ¼', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'6503': { symbol: '6503', name: 'ä¸‰è±é›»æ©Ÿ', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'6762': { symbol: '6762', name: 'TDK', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// æƒ…å ±ãƒ»é€šä¿¡æ¥­
	'9984': { symbol: '9984', name: 'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'4689': { symbol: '4689', name: 'LINEãƒ¤ãƒ•ãƒ¼', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'9613': { symbol: '9613', name: 'ã‚¨ãƒŒãƒ»ãƒ†ã‚£ãƒ»ãƒ†ã‚£ãƒ»ãƒ‡ãƒ¼ã‚¿', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'9432': { symbol: '9432', name: 'æ—¥æœ¬é›»ä¿¡é›»è©±', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'9434': { symbol: '9434', name: 'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'4751': { symbol: '4751', name: 'ã‚µã‚¤ãƒãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'3659': { symbol: '3659', name: 'ãƒã‚¯ã‚½ãƒ³', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// é‡‘èæ¥­
	'8306': { symbol: '8306', name: 'ä¸‰è±UFJãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'8316': { symbol: '8316', name: 'ä¸‰äº•ä½å‹ãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'8411': { symbol: '8411', name: 'ã¿ãšã»ãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'8058': { symbol: '8058', name: 'ä¸‰è±å•†äº‹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'8031': { symbol: '8031', name: 'ä¸‰äº•ç‰©ç”£', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// å°å£²æ¥­
	'9983': { symbol: '9983', name: 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'3382': { symbol: '3382', name: 'ã‚»ãƒ–ãƒ³&ã‚¢ã‚¤ãƒ»ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'8267': { symbol: '8267', name: 'ã‚¤ã‚ªãƒ³', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'3099': { symbol: '3099', name: 'ä¸‰è¶Šä¼Šå‹¢ä¸¹ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// åŒ»è–¬å“
	'4568': { symbol: '4568', name: 'ç¬¬ä¸€ä¸‰å…±', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'4502': { symbol: '4502', name: 'æ­¦ç”°è–¬å“å·¥æ¥­', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'4523': { symbol: '4523', name: 'ã‚¨ãƒ¼ã‚¶ã‚¤', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'4578': { symbol: '4578', name: 'å¤§å¡šãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆ
	'7974': { symbol: '7974', name: 'ä»»å¤©å ‚', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'6178': { symbol: '6178', name: 'æ—¥æœ¬éƒµæ”¿', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'9766': { symbol: '9766', name: 'ã‚³ãƒŠãƒŸã‚°ãƒ«ãƒ¼ãƒ—', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'7832': { symbol: '7832', name: 'ãƒãƒ³ãƒ€ã‚¤ãƒŠãƒ ã‚³ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ»å•†ç¤¾
	'1605': { symbol: '1605', name: 'å›½éš›çŸ³æ²¹é–‹ç™ºå¸çŸ³', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'5020': { symbol: '5020', name: 'ENEOSãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'1928': { symbol: '1928', name: 'ç©æ°´ãƒã‚¦ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// å»ºè¨­æ¥­
	'1801': { symbol: '1801', name: 'å¤§æˆå»ºè¨­', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'1802': { symbol: '1802', name: 'å¤§æ—çµ„', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'1803': { symbol: '1803', name: 'æ¸…æ°´å»ºè¨­', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'1925': { symbol: '1925', name: 'å¤§å’Œãƒã‚¦ã‚¹å·¥æ¥­', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// åŒ–å­¦
	'4063': { symbol: '4063', name: 'ä¿¡è¶ŠåŒ–å­¦å·¥æ¥­', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'4188': { symbol: '4188', name: 'ä¸‰è±ã‚±ãƒŸã‚«ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'4005': { symbol: '4005', name: 'ä½å‹åŒ–å­¦', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// é£Ÿå“
	'2502': { symbol: '2502', name: 'ã‚¢ã‚µãƒ’ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'2503': { symbol: '2503', name: 'ã‚­ãƒªãƒ³ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'2269': { symbol: '2269', name: 'æ˜æ²»ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'2801': { symbol: '2801', name: 'ã‚­ãƒƒã‚³ãƒ¼ãƒãƒ³', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// é‰„é‹¼
	'5401': { symbol: '5401', name: 'æ—¥æœ¬è£½é‰„', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'5411': { symbol: '5411', name: 'JFEãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },

	// èˆªç©ºãƒ»é‹è¼¸
	'9201': { symbol: '9201', name: 'æ—¥æœ¬èˆªç©º', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'9202': { symbol: '9202', name: 'ANA ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'9020': { symbol: '9020', name: 'æ±æ—¥æœ¬æ—…å®¢é‰„é“', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' },
	'9022': { symbol: '9022', name: 'æ±æµ·æ—…å®¢é‰„é“', market: 'æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ' }
};

/**
 * è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã‹ã‚‰éŠ˜æŸ„æƒ…å ±ã‚’å–å¾—
 * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥: Stooq API â†’ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
 */
export async function getStockInfo(symbol: string): Promise<StockInfo | null> {
	console.log(`[stockInfoService] Getting stock info for: ${symbol}`);

	// 4æ¡ã®æ•°å­—ã®ã¿è¨±å¯
	if (!/^\d{4}$/.test(symbol)) {
		console.log(`[stockInfoService] Invalid symbol format: ${symbol}`);
		return null;
	}

	try {
		// 1. ã¾ãšStooq API ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
		console.log(`[stockInfoService] Calling Stooq API...`);
		const apiResult = await getStockInfoFromStooq(symbol);

		if (apiResult) {
			console.log(`ğŸŒ APIçµŒç”±ã§éŠ˜æŸ„æƒ…å ±ã‚’å–å¾—: ${symbol} = ${apiResult.name}`);
			return apiResult;
		}

		console.log(`âš ï¸ API ã§è¦‹ã¤ã‹ã‚‰ãšã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª: ${symbol}`);
	} catch (error) {
		console.error('ğŸš¨ API ã‚¨ãƒ©ãƒ¼ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
	}

	// 2. APIã§å–å¾—ã§ããªã„å ´åˆã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
	const hardcodedInfo = STOCK_INFO_MAP[symbol];
	if (hardcodedInfo) {
		console.log(`ğŸ“š ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—: ${symbol} = ${hardcodedInfo.name}`);
		return hardcodedInfo;
	}

	console.log(`âŒ éŠ˜æŸ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${symbol}`);
	return null;
}

/**
 * éŠ˜æŸ„åã§ã®éƒ¨åˆ†æ¤œç´¢
 */
export async function searchStocksByName(partialName: string): Promise<StockInfo[]> {
	if (!partialName || partialName.length < 1) {
		return [];
	}

	return Object.values(STOCK_INFO_MAP).filter((stock) => stock.name.includes(partialName));
}

/**
 * ã™ã¹ã¦ã®éŠ˜æŸ„ã‚’å–å¾—ï¼ˆé–‹ç™ºç”¨ï¼‰
 */
export async function getAllStockInfo(): Promise<StockInfo[]> {
	return Object.values(STOCK_INFO_MAP);
}
